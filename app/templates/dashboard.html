<!DOCTYPE html>
<html>
  <head>
    <title>Smart Humidity-Soil Fan System Dashboard</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 30px;
        background-color: #f0f4f7;
      }
      h1 {
        color: #333;
      }
      ul {
        list-style: none;
        padding: 0;
      }
      li {
        margin-bottom: 10px;
        font-size: 1.2em;
      }
      .status {
        font-weight: bold;
        font-size: 1.4em;
        color: #0077cc;
      }
      .control-panel {
        margin-top: 20px;
      }
      .control-btn {
        padding: 10px 15px;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1.1em;
      }
      .control-btn.off {
        background-color: #f44336;
      }
    </style>
  </head>
  <body>
    <h1>Smart Humidity-Soil Fan System Dashboard</h1>
    <p>Chung Bao An Nguyen - 103485260</p>

    <ul id="sensorData">
      <li>
        <strong>Soil Moisture:</strong> <span id="soil">Loading...</span>%
      </li>
      <li><strong>Temperature:</strong> <span id="temp">Loading...</span>Â°C</li>
      <li><strong>Humidity:</strong> <span id="hum">Loading...</span>%</li>
      <li><strong>Timestamp:</strong> <span id="time">Loading...</span></li>
      <li class="status">
        <strong>Status:</strong> <span id="status">Loading...</span>
      </li>
    </ul>

    <div class="control-panel">
      <button id="fanToggle" class="control-btn">Turn Fan ON</button>
    </div>

    <script>
      async function fetchSensorData() {
        try {
          const response = await fetch("/api/sensor");
          const data = await response.json();

          document.getElementById("soil").textContent = data.soil_moisture;
          document.getElementById("temp").textContent = parseFloat(
            data.temperature
          ).toFixed(2);
          document.getElementById("hum").textContent = parseFloat(
            data.humidity
          ).toFixed(1);
          document.getElementById("time").textContent = data.timestamp;

          // Determine status based on your Arduino rules
          let status = "Monitoring...";

          if (data.temperature > 35.0 && data.humidity < 30.0) {
            status = "Extreme Heat and Dryness! (Fan ON)";
          } else if (data.humidity > 60.0 || data.temperature > 30.0) {
            status = "High Humidity or Temperature (Fan ON)";
          } else if (data.soil_moisture <= 5) {
            status = "Soil Sensor Error or Very Dry (Buzzer Alert)";
          } else {
            status = "Normal Conditions (Fan OFF)";
          }

          document.getElementById("status").textContent = status;
        } catch (error) {
          console.error("Error fetching sensor data:", error);
        }
      }

      // Fetch new data every 5 seconds
      setInterval(fetchSensorData, 5000);

      // Fetch once immediately on page load
      fetchSensorData();

      // Fan control
      const fanToggleBtn = document.getElementById("fanToggle");
      let fanIsOn = false;

      // Check current fan state when page loads
      async function checkFanState() {
        try {
          const response = await fetch("/api/fan");
          const data = await response.json();
          fanIsOn = data.fan_state;

          // Update button text and style
          if (fanIsOn) {
            fanToggleBtn.textContent = "Turn Fan OFF";
            fanToggleBtn.classList.add("off");
          } else {
            fanToggleBtn.textContent = "Turn Fan ON";
            fanToggleBtn.classList.remove("off");
          }
        } catch (error) {
          console.error("Error checking fan state:", error);
        }
      }

      // Check fan state on page load
      checkFanState();

      fanToggleBtn.addEventListener("click", async () => {
        try {
          const action = fanIsOn ? "off" : "on";
          const response = await fetch("/api/fan", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ action }),
          });

          const data = await response.json();
          fanIsOn = data.fan_state;

          // Update button text and style
          if (fanIsOn) {
            fanToggleBtn.textContent = "Turn Fan OFF";
            fanToggleBtn.classList.add("off");
          } else {
            fanToggleBtn.textContent = "Turn Fan ON";
            fanToggleBtn.classList.remove("off");
          }
        } catch (error) {
          console.error("Error toggling fan:", error);
        }
      });
    </script>
  </body>
</html>
